<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í›„ë³´ ë‹¹ì„  í™•ë¥  ì°¨íŠ¸</title>
  <style>
    /* ê°œì„ ëœ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
    :root {
      --background-color: #f8f9fa;
      --container-bg: white;
      --text-color: #333;
      --border-color: #ddd;
      --header-color: #1a73e8;
      --button-color: #1a73e8;
      --button-hover: #0d47a1;
      --footer-color: #666;
      --spinner-border: #f3f3f3;
      --spinner-top: #1a73e8;
      --box-shadow: rgba(0,0,0,0.1);
    }
    
    .dark-mode {
      --background-color: #121212;
      --container-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --border-color: #444;
      --header-color: #4dabf7;
      --button-color: #4dabf7;
      --button-hover: #74c0fc;
      --footer-color: #adb5bd;
      --spinner-border: #333;
      --spinner-top: #4dabf7;
      --box-shadow: rgba(0,0,0,0.3);
    }
    
    body {
      font-family: 'Noto Sans KR', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--container-bg);
      border-radius: 10px;
      box-shadow: 0 2px 10px var(--box-shadow);
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--header-color);
      transition: color 0.3s;
    }
    
    .chart-container {
      position: relative;
      margin: auto;
      height: 70vh;
      width: 100%;
    }
    
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    
    .loading-spinner {
      border: 5px solid var(--spinner-border);
      border-top: 5px solid var(--spinner-top);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
      transition: border-color 0.3s;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    
    .date-range {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
      justify-content: center;
    }
    
    .date-range label {
      font-weight: bold;
    }
    
    .date-range input {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--container-bg);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    
    button {
      background-color: var(--button-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: var(--button-hover);
    }
    
    .candidate-legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 5px;
      border-radius: 3px;
    }
    
    .legend-text {
      font-size: 14px;
    }
    
    .legend-text.inactive {
      text-decoration: line-through;
      opacity: 0.5;
    }
    
    footer {
      text-align: center;
      margin-top: 30px;
      font-size: 12px;
      color: var(--footer-color);
      transition: color 0.3s;
    }
    
    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .theme-toggle-button {
      background-color: var(--button-color);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background-color 0.3s;
    }
    
    .theme-toggle-button:hover {
      background-color: var(--button-hover);
    }
    
    .theme-icon {
      font-size: 16px;
    }
    
    @media (max-width: 768px) {
      .chart-container {
        height: 60vh;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .theme-toggle {
        top: 10px;
        right: 10px;
      }
    }
  </style>
  <!-- Google Fonts - Noto Sans KR -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="theme-toggle">
    <button id="themeToggle" class="theme-toggle-button">
      <span class="theme-icon">ğŸŒ™</span> ë‹¤í¬ëª¨ë“œ
    </button>
  </div>
  <div class="container">
    <h1>2025 ëŒ€ì„  í›„ë³´ë³„ ë‹¹ì„  í™•ë¥  íŠ¸ë Œë“œ</h1>
    
    <div class="date-range">
      <label for="startDate">ì‹œì‘ì¼:</label>
      <input type="date" id="startDate">
      <label for="endDate">ì¢…ë£Œì¼:</label>
      <input type="date" id="endDate">
      <button id="applyDateFilter">ì ìš©</button>
      <button id="resetDateFilter">ì´ˆê¸°í™”</button>
      <button id="lastWeek">ì§ì „ ì¼ì£¼ì¼</button>
      <button id="last30Days">ì§ì „ 30ì¼</button>
      <button id="last3Months">ì§ì „ 3ê°œì›”</button>
    </div>
    
    <div class="candidate-legend" id="candidateLegend">
      <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë™ì  ìƒì„±ë¨ -->
    </div>
    
    <div class="chart-container">
      <div id="loadingIndicator" class="loading">
        <div class="loading-spinner"></div>
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
      <canvas id="electionChart"></canvas>
    </div>
    
    <div class="controls">
      <button id="toggleAllCandidates">ëª¨ë“  í›„ë³´ í‘œì‹œ/ìˆ¨ê¹€</button>
    </div>
    
    <footer>
      ë°ì´í„° ì¶œì²˜: Google Sheets ê³µê°œ CSV | ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">ë¡œë”© ì¤‘...</span>
    </footer>
  </div>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Datalabels í”ŒëŸ¬ê·¸ì¸ (CDN) - ë²„ì „ ë³€ê²½ ë° ìœ„ì¹˜ ì¡°ì • -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <!-- Papa Parse (CSV íŒŒì‹±ìš©, CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- ë‚ ì§œ í¬ë§·íŒ…ì„ ìœ„í•œ Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/locale/ko.js"></script>

  <script>
    // Chart.js Datalabels í”ŒëŸ¬ê·¸ì¸ ì „ì—­ ë³€ìˆ˜ ì„¤ì • - ì˜¤ë¥˜ ì²˜ë¦¬ ì¶”ê°€
    let ChartDataLabels = null;
    try {
      ChartDataLabels = window['chartjs-plugin-datalabels'];
      // í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
      Chart.register(ChartDataLabels);
    } catch (e) {
      console.error("Datalabels í”ŒëŸ¬ê·¸ì¸ ë¡œë“œ ì˜¤ë¥˜:", e);
    }
    
    // ë‹¤í¬ëª¨ë“œ í† ê¸€ ê¸°ëŠ¥
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    
    // ì‚¬ìš©ì ì‹œìŠ¤í…œ ì„¤ì •ì´ë‚˜ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í…Œë§ˆ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark' || (!savedTheme && prefersDarkScheme.matches)) {
      body.classList.add('dark-mode');
      themeToggle.innerHTML = '<span class="theme-icon">â˜€ï¸</span> ë¼ì´íŠ¸ëª¨ë“œ';
    }
    
    themeToggle.addEventListener('click', () => {
      if (body.classList.contains('dark-mode')) {
        body.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
        themeToggle.innerHTML = '<span class="theme-icon">ğŸŒ™</span> ë‹¤í¬ëª¨ë“œ';
        
        // ì°¨íŠ¸ í…Œë§ˆ ì—…ë°ì´íŠ¸ (ë¼ì´íŠ¸ëª¨ë“œ)
        if (chart) {
          chart.options.scales.x.grid.color = 'rgba(0, 0, 0, 0.1)';
          chart.options.scales.y.grid.color = 'rgba(0, 0, 0, 0.1)';
          chart.options.scales.x.ticks.color = '#666';
          chart.options.scales.y.ticks.color = '#666';
          chart.options.scales.x.title.color = '#666';
          chart.options.scales.y.title.color = '#666';
          chart.options.plugins.title.color = '#333';
          // datalabels ë°°ê²½ìƒ‰ ì—…ë°ì´íŠ¸
          chart.update();
        }
      } else {
        body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
        themeToggle.innerHTML = '<span class="theme-icon">â˜€ï¸</span> ë¼ì´íŠ¸ëª¨ë“œ';
        
        // ì°¨íŠ¸ í…Œë§ˆ ì—…ë°ì´íŠ¸ (ë‹¤í¬ëª¨ë“œ)
        if (chart) {
          chart.options.scales.x.grid.color = 'rgba(255, 255, 255, 0.1)';
          chart.options.scales.y.grid.color = 'rgba(255, 255, 255, 0.1)';
          chart.options.scales.x.ticks.color = '#adb5bd';
          chart.options.scales.y.ticks.color = '#adb5bd';
          chart.options.scales.x.title.color = '#e0e0e0';
          chart.options.scales.y.title.color = '#e0e0e0';
          chart.options.plugins.title.color = '#e0e0e0';
          // datalabels ë°°ê²½ìƒ‰ ì—…ë°ì´íŠ¸
          chart.update();
        }
      }
    });
    
    // ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    // Google Sheets ì •ë³´
    const spreadsheetId = '1FBkYF5tZDBCFqyg1U-h9TLikdTDA1NUpxIFAGJ7eDvw'; // ì‹¤ì œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID
    const sheetName = 'csv'; // ì‹¤ì œ ì‹œíŠ¸ ì´ë¦„
    const apiKey = 'AIzaSyBb2nNqLgPKBnOaWdr5dtAoc1U9Wn6v5IU'; // ì‹¤ì œ API í‚¤

    // Google Sheets API URL
    const sheetsApiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}?key=${apiKey}`;
    
    // 2) í›„ë³´ì ì»¬ëŸ¼ ì´ë¦„ (CSV í—¤ë”ì™€ ë™ì¼í•˜ê²Œ)
    //    "date_day" ì™¸ì— ì‹¤ì œ í›„ë³´ ì´ë¦„ ì»¬ëŸ¼ 8ê°œ
    const candidateLabels = [
      "ì´ì¬ëª…", "ê¹€ë™ì—°", "ê¹€ë¬¸ìˆ˜", "í•œë™í›ˆ",
      "í™ì¤€í‘œ", "ì˜¤ì„¸í›ˆ", "ì´ì¤€ì„", "ì´ë‚™ì—°"
    ];
    
    // 3) í›„ë³´ìë³„ ìƒ‰ìƒ ì§€ì •
    const candidateColors = {
      "ì´ì¬ëª…": "#152484", // ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹
      "ê¹€ë™ì—°": "#152484", // ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹
      "ê¹€ë¬¸ìˆ˜": "#E61E2B", // êµ­ë¯¼ì˜í˜
      "í•œë™í›ˆ": "#E61E2B", // êµ­ë¯¼ì˜í˜
      "í™ì¤€í‘œ": "#E61E2B", // êµ­ë¯¼ì˜í˜
      "ì˜¤ì„¸í›ˆ": "#E61E2B", // êµ­ë¯¼ì˜í˜
      "ì´ì¤€ì„": "#FF7210", // ê°œí˜ì‹ ë‹¹
      "ì´ë‚™ì—°": "#45BABD"  // ìƒˆë¯¸ë˜ë¯¼ì£¼ë‹¹
    };
    
    // í›„ë³´ìë³„ ë¼ì¸ ìŠ¤íƒ€ì¼ ì„¤ì •
    const candidateStyles = {
      "ì´ì¬ëª…": { borderDash: [], pointStyle: 'circle' },
      "ê¹€ë™ì—°": { borderDash: [5, 5], pointStyle: 'triangle' },
      "ê¹€ë¬¸ìˆ˜": { borderDash: [], pointStyle: 'circle' },
      "í•œë™í›ˆ": { borderDash: [5, 5], pointStyle: 'triangle' },
      "í™ì¤€í‘œ": { borderDash: [10, 10], pointStyle: 'rect' },
      "ì˜¤ì„¸í›ˆ": { borderDash: [15, 5], pointStyle: 'star' },
      "ì´ì¤€ì„": { borderDash: [], pointStyle: 'circle' },
      "ì´ë‚™ì—°": { borderDash: [], pointStyle: 'circle' }
    };
    
    // ì „ì—­ ë³€ìˆ˜
    let chart = null;
    let allData = [];
    let filteredData = [];
    let visibleCandidates = [...candidateLabels];
    let thirtyDaysAgo;
    let lastDate;
    
    // ë‚ ì§œ í˜•ì‹ ë³€í™˜ (YYYY-MM-DD)
    const formatDate = (date) => {
      return date.toISOString().split('T')[0];
    };
    
    // dayjs í•œêµ­ì–´ ë¡œì¼€ì¼ ì„¤ì •
    dayjs.locale('ko');
    
    // Google Sheets APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ë¡œë“œ
    // ì°¸ê³ : Google Sheets APIë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë‹¤ìŒ ë‹¨ê³„ê°€ í•„ìš”í•©ë‹ˆë‹¤:
    // 1. Google Cloud Console(https://console.cloud.google.com/)ì—ì„œ í”„ë¡œì íŠ¸ ìƒì„±
    // 2. Google Sheets API í™œì„±í™”
    // 3. API í‚¤ ìƒì„± (ì œí•œì‚¬í•­: HTTP ë¦¬í¼ëŸ¬ ì œí•œ ì„¤ì • ê¶Œì¥)
    // 4. ìƒì„±ëœ API í‚¤ë¥¼ ìœ„ì˜ apiKey ë³€ìˆ˜ì— ì…ë ¥
    // 5. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDì™€ ì‹œíŠ¸ ì´ë¦„ ì„¤ì •
    //
    // ì‹¤ì œ API í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ Google Sheets APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    loadDataFromGoogleSheetsApi(); // APIë¥¼ í†µí•´ ì‹¤ì œ ë°ì´í„° ë¡œë“œ
    
    // Google Sheets APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    function loadDataFromGoogleSheetsApi() {
      // ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
      loadingIndicator.style.display = 'block';
      loadingIndicator.innerHTML = `
        <div class="loading-spinner"></div>
        <p>Google Sheets APIì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
      `;
      
      fetch(sheetsApiUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data && data.values && data.values.length > 0) {
            // API ì‘ë‹µì—ì„œ ë°ì´í„° ì¶”ì¶œ ë° ê°€ê³µ
            const headers = data.values[0]; // ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”
            const rows = data.values.slice(1); // ë‚˜ë¨¸ì§€ í–‰ì€ ë°ì´í„°
            
            // í—¤ë”ì™€ ë°ì´í„°ë¥¼ ê²°í•©í•˜ì—¬ ê°ì²´ ë°°ì—´ ìƒì„±
            const parsedData = rows.map(row => {
              const rowData = {};
              headers.forEach((header, index) => {
                rowData[header] = row[index] || '';
              });
              return rowData;
            });
            
            processData(parsedData);
            
            // ì‹¤ì œ ë°ì´í„° ì‚¬ìš© ì•Œë¦¼
            const footer = document.querySelector('footer');
            footer.innerHTML = `ë°ì´í„° ì¶œì²˜: Google Sheets API | ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">ë¡œë”© ì¤‘...</span>`;
            updateLastUpdateDate();
          } else {
            throw new Error("API ì‘ë‹µì— ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }
        })
        .catch(err => {
          console.error("Google Sheets API ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", err);
          loadingIndicator.innerHTML = `
            <p>Google Sheets API ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}</p>
            <button id="retryFetch" style="margin-top: 20px;">ë‹¤ì‹œ ì‹œë„</button>
          `;
          
          document.getElementById('retryFetch').addEventListener('click', () => {
            loadDataFromGoogleSheetsApi();
          });
        });
    }
    
    // ë°ì´í„° ì²˜ë¦¬ ê³µí†µ í•¨ìˆ˜
    function processData(data) {
      allData = data;
      
      // ë°ì´í„° ì •ë ¬ (ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ)
      allData.sort((a, b) => {
        return new Date(b["date_day"]) - new Date(a["date_day"]);
      });
      
      // ìµœê·¼ 30ì¼ ë°ì´í„°ë§Œ í•„í„°ë§
      lastDate = new Date(allData[0]["date_day"]);
      thirtyDaysAgo = new Date(lastDate);
      thirtyDaysAgo.setDate(lastDate.getDate() - 30);
      
      filteredData = allData.filter(row => {
        const rowDate = new Date(row["date_day"]);
        return rowDate >= thirtyDaysAgo && rowDate <= lastDate;
      });
      
      // ë‚ ì§œ í•„í„° ì´ˆê¸°í™”
      initializeDateFilters();
      
      // í›„ë³´ì ë ˆì „ë“œ ìƒì„±
      createCandidateLegend();
      
      // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ë‚ ì§œ í‘œì‹œ
      updateLastUpdateDate();
      
      // ì°¨íŠ¸ ë Œë”ë§
      renderChart(filteredData);
      
      // ë¡œë”© ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
      loadingIndicator.style.display = 'none';
    }
    
    // ë‚ ì§œ í•„í„° ì´ˆê¸°í™”
    function initializeDateFilters() {
      if (allData.length === 0) return;
      
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      
      // ë°ì´í„°ì˜ ì²« ë‚ ì§œì™€ ë§ˆì§€ë§‰ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
      const firstDate = new Date(allData[allData.length - 1]["date_day"]);
      
      // ì…ë ¥ í•„ë“œì— ë‚ ì§œ ì„¤ì •
      startDateInput.value = formatDate(thirtyDaysAgo);
      endDateInput.value = formatDate(lastDate);
      
      // ë°ì´í„°ê°€ ìˆëŠ” ë‚ ì§œë“¤ì„ ì¶”ì¶œí•˜ì—¬ ë°°ì—´ë¡œ ì €ì¥
      const availableDates = allData.map(row => row["date_day"]);
      
      // ë‚ ì§œ ì…ë ¥ í•„ë“œì— ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      startDateInput.addEventListener('input', function() {
        validateDateInput(this, availableDates);
      });
      
      endDateInput.addEventListener('input', function() {
        validateDateInput(this, availableDates);
      });
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ë‹¤ì‹œ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
      document.getElementById('applyDateFilter').removeEventListener('click', applyDateFilter);
      document.getElementById('resetDateFilter').removeEventListener('click', resetDateFilter);
      document.getElementById('lastWeek').removeEventListener('click', () => setDateRange(7));
      document.getElementById('last30Days').removeEventListener('click', () => setDateRange(30));
      document.getElementById('last3Months').removeEventListener('click', () => setDateRange(90));
      
      // ë‚ ì§œ í•„í„° ì ìš© ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('applyDateFilter').addEventListener('click', applyDateFilter);
      
      // ë‚ ì§œ í•„í„° ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('resetDateFilter').addEventListener('click', resetDateFilter);
      
      // ë‚ ì§œ ë²”ìœ„ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
      document.getElementById('lastWeek').addEventListener('click', function() { setDateRange(7); });
      document.getElementById('last30Days').addEventListener('click', function() { setDateRange(30); });
      document.getElementById('last3Months').addEventListener('click', function() { setDateRange(90); });
      
      // ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œ ëª©ë¡ì„ ì„¤ì •
      setAvailableDates(startDateInput, availableDates);
      setAvailableDates(endDateInput, availableDates);
    }
    
    // ë‚ ì§œ ì…ë ¥ í•„ë“œì— ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œ ì„¤ì •
    function setAvailableDates(dateInput, availableDates) {
      // ê¸°ì¡´ min, max ì†ì„± ì„¤ì •
      const firstAvailableDate = new Date(availableDates[availableDates.length - 1]);
      const lastAvailableDate = new Date(availableDates[0]);
      
      dateInput.min = formatDate(firstAvailableDate);
      dateInput.max = formatDate(lastAvailableDate);
      
      // ì‚¬ìš©ì ì •ì˜ ë°ì´í„° ì†ì„±ì— ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œ ëª©ë¡ ì €ì¥
      dateInput.dataset.availableDates = JSON.stringify(availableDates);
    }
    
    // ë‚ ì§œ ì…ë ¥ ìœ íš¨ì„± ê²€ì‚¬
    function validateDateInput(input, availableDates) {
      const selectedDate = input.value;
      
      // ì„ íƒëœ ë‚ ì§œê°€ ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œ ëª©ë¡ì— ì—†ìœ¼ë©´ ê°€ì¥ ê°€ê¹Œìš´ ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œë¡œ ë³€ê²½
      if (!availableDates.includes(selectedDate)) {
        // ê°€ì¥ ê°€ê¹Œìš´ ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œ ì°¾ê¸°
        const closestDate = findClosestDate(selectedDate, availableDates);
        input.value = closestDate;
        
        // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
        alert(`ì„ íƒí•˜ì‹  ë‚ ì§œ(${selectedDate})ì—ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê°€ì¥ ê°€ê¹Œìš´ ë‚ ì§œ(${closestDate})ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
    }
    
    // ê°€ì¥ ê°€ê¹Œìš´ ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œ ì°¾ê¸°
    function findClosestDate(targetDate, availableDates) {
      const target = new Date(targetDate);
      
      // ë‚ ì§œ ì°¨ì´ë¥¼ ê³„ì‚°í•˜ì—¬ ê°€ì¥ ê°€ê¹Œìš´ ë‚ ì§œ ì°¾ê¸°
      let closestDate = availableDates[0];
      let minDiff = Math.abs(target - new Date(availableDates[0]));
      
      for (let i = 1; i < availableDates.length; i++) {
        const diff = Math.abs(target - new Date(availableDates[i]));
        if (diff < minDiff) {
          minDiff = diff;
          closestDate = availableDates[i];
        }
      }
      
      return closestDate;
    }
    
    // ë‚ ì§œ í•„í„° ì ìš©
    function applyDateFilter() {
      const startDate = new Date(document.getElementById('startDate').value);
      const endDate = new Date(document.getElementById('endDate').value);
      
      // ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ì´ì „ì´ë©´ ê²½ê³ 
      if (endDate < startDate) {
        alert('ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      // ë‚ ì§œ ë²”ìœ„ì— ë§ëŠ” ë°ì´í„° í•„í„°ë§
      filteredData = allData.filter(row => {
        const rowDate = new Date(row["date_day"]);
        return rowDate >= startDate && rowDate <= endDate;
      });
      
      // ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
      renderChart(filteredData);
    }
    
    // ë‚ ì§œ í•„í„° ì´ˆê¸°í™”
    function resetDateFilter() {
      initializeDateFilters();
      filteredData = [...allData];
      renderChart(filteredData);
    }
    
    // í›„ë³´ì ë ˆì „ë“œ ìƒì„±
    function createCandidateLegend() {
      const legendContainer = document.getElementById('candidateLegend');
      legendContainer.innerHTML = '';
      
      candidateLabels.forEach(candidate => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.dataset.candidate = candidate;
        
        const colorBox = document.createElement('div');
        colorBox.className = 'legend-color';
        colorBox.style.backgroundColor = candidateColors[candidate];
        
        const text = document.createElement('span');
        text.className = 'legend-text';
        text.textContent = candidate;
        
        legendItem.appendChild(colorBox);
        legendItem.appendChild(text);
        
        // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        legendItem.addEventListener('click', () => toggleCandidate(candidate, text));
        
        legendContainer.appendChild(legendItem);
      });
      
      // ëª¨ë“  í›„ë³´ í‘œì‹œ/ìˆ¨ê¹€ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('toggleAllCandidates').addEventListener('click', toggleAllCandidates);
    }
    
    // í›„ë³´ì í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
    function toggleCandidate(candidate, textElement) {
      const index = visibleCandidates.indexOf(candidate);
      
      if (index !== -1) {
        // í›„ë³´ì ìˆ¨ê¸°ê¸°
        visibleCandidates.splice(index, 1);
        textElement.classList.add('inactive');
      } else {
        // í›„ë³´ì í‘œì‹œ
        visibleCandidates.push(candidate);
        textElement.classList.remove('inactive');
      }
      
      // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
      updateChartVisibility();
    }
    
    // ëª¨ë“  í›„ë³´ì í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
    function toggleAllCandidates() {
      const legendTexts = document.querySelectorAll('.legend-text');
      
      if (visibleCandidates.length > 0) {
        // ëª¨ë“  í›„ë³´ì ìˆ¨ê¸°ê¸°
        visibleCandidates = [];
        legendTexts.forEach(text => text.classList.add('inactive'));
      } else {
        // ëª¨ë“  í›„ë³´ì í‘œì‹œ
        visibleCandidates = [...candidateLabels];
        legendTexts.forEach(text => text.classList.remove('inactive'));
      }
      
      // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
      updateChartVisibility();
    }
    
    // ì°¨íŠ¸ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
    function updateChartVisibility() {
      if (!chart) return;
      
      chart.data.datasets.forEach(dataset => {
        const isVisible = visibleCandidates.includes(dataset.label);
        dataset.hidden = !isVisible;
      });
      
      chart.update();
    }
    
    // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ë‚ ì§œ í‘œì‹œ
    function updateLastUpdateDate() {
      if (allData.length === 0) return;
      
      const lastDate = new Date(allData[0]["date_day"]);
      const formattedDate = dayjs(lastDate).format('YYYYë…„ MMì›” DDì¼');
      
      document.getElementById('lastUpdate').textContent = formattedDate;
    }

    // ì°¨íŠ¸ë¥¼ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    function renderChart(rows) {
      // (1) Xì¶• ë¼ë²¨ë¡œ ì‚¬ìš©í•  ë°°ì—´ (date_day)
      const labels = [];
      // ì›ë³¸ ë‚ ì§œ ë°ì´í„° ì €ì¥ ë°°ì—´ ì¶”ê°€
      const originalDates = [];

      // (2) í›„ë³´ìë³„ ë°ì´í„° ì €ì¥ìš© ê°ì²´
      //     ì˜ˆ: { "ì´ì¬ëª…": [], "ê¹€ë™ì—°": [], ... }
      const candidateDataMap = {};
      candidateLabels.forEach(candidate => {
        candidateDataMap[candidate] = [];
      });

      // ë°ì´í„°ë¥¼ ì—­ìˆœìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸° ì „ì— ì›ë³¸ ë°°ì—´ ë³µì‚¬
      const sortedRows = [...rows].reverse();

      // (3) CSV ê° í–‰ì„ ìˆœíšŒí•˜ë©°, date_dayì™€ í›„ë³´ì í¼ì„¼íŠ¸ë¥¼ ì¶”ì¶œ
      // ë°ì´í„°ë¥¼ ì—­ìˆœìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ì˜¤ë˜ëœ ë‚ ì§œë¶€í„° ìµœì‹  ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬
      sortedRows.forEach(row => {
        // A. Xì¶• ë¼ë²¨: row["date_day"] (ì˜ˆ: "2025-03-10")
        const dateDay = row["date_day"];
        // ì›ë³¸ ë‚ ì§œ ì €ì¥
        originalDates.push(dateDay);
        // ë‚ ì§œ í¬ë§·íŒ… (M/D(ddd))
        const formattedDate = dayjs(dateDay).format('M/D(ddd)');
        labels.push(formattedDate);

        // B. í›„ë³´ìë³„ í¼ì„¼íŠ¸ ê°’ì„ ìˆ«ìë¡œ ë³€í™˜
        candidateLabels.forEach(candidate => {
          // ì˜ˆ: row["ì´ì¬ëª…"]ê°€ "44%" í˜•íƒœë¼ë©´, "%" ì œê±° í›„ parseFloat
          const rawValue = row[candidate] || "0%";
          const numericValue = parseFloat(rawValue.replace("%", "")) || 0;
          candidateDataMap[candidate].push(numericValue);
        });
      });

      // (4) Chart.jsì— ì‚¬ìš©í•  datasets ë°°ì—´ ìƒì„±
      const datasets = candidateLabels.map(candidate => {
        return {
          label: candidate,
          data: candidateDataMap[candidate],
          fill: false,
          borderWidth: 3,
          borderColor: candidateColors[candidate],
          backgroundColor: candidateColors[candidate],
          tension: 0.2,
          pointRadius: 2,
          pointHoverRadius: 6,
          borderDash: candidateStyles[candidate].borderDash,
          pointStyle: candidateStyles[candidate].pointStyle,
          hidden: !visibleCandidates.includes(candidate)
        };
      });

      // (5) ì°¨íŠ¸ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
      const ctx = document.getElementById('electionChart').getContext('2d');
      
      // ìµœëŒ€ê°’ ê³„ì‚°
      let maxValue = 0;
      candidateLabels.forEach(candidate => {
        const candidateMax = Math.max(...candidateDataMap[candidate]);
        maxValue = Math.max(maxValue, candidateMax);
      });

      // Yì¶• ìµœëŒ€ê°’ ì„¤ì • (ê¸°ë³¸ 50%, ë°ì´í„°ê°€ 50% ì´ˆê³¼ì‹œ ì˜¬ë¦¼í•˜ì—¬ ì„¤ì •)
      const yAxisMax = maxValue > 50 ? Math.ceil(maxValue / 10) * 10 : 50;

      if (chart) {
        // ê¸°ì¡´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        chart.data.labels = labels;
        chart.data.datasets = datasets;
        chart.data.originalDates = originalDates; // ì›ë³¸ ë‚ ì§œ ë°ì´í„° ì—…ë°ì´íŠ¸
        chart.options.scales.y.max = yAxisMax;
        chart.update();
      } else {
        // ë‹¤í¬ëª¨ë“œ ì—¬ë¶€ì— ë”°ë¥¸ ì°¨íŠ¸ ìƒ‰ìƒ ì„¤ì •
        const isDarkMode = body.classList.contains('dark-mode');
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = isDarkMode ? '#e0e0e0' : '#333';
        const tickColor = isDarkMode ? '#adb5bd' : '#666';
        
        // ì°¨íŠ¸ ì˜µì…˜ ì„¤ì •
        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'í›„ë³´ìë³„ ê²€ìƒ‰ ë¹„ìœ¨(%)',
              font: {
                size: 16,
                weight: 'bold'
              },
              padding: {
                top: 10,
                bottom: 20
              },
              color: textColor
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              position: 'nearest',
              itemSort: function(a, b) {
                return b.raw - a.raw;
              },
              callbacks: {
                title: function(tooltipItems) {
                  // ë°ì´í„° ì¸ë±ìŠ¤ ê°€ì ¸ì˜¤ê¸°
                  const dataIndex = tooltipItems[0].dataIndex;
                  
                  // ì°¨íŠ¸ ë°ì´í„°ì— ì €ì¥ëœ ì›ë³¸ ë‚ ì§œ ë°°ì—´ì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
                  const originalDate = chart.data.originalDates[dataIndex];
                  
                  // ì›ë³¸ ë‚ ì§œ ë°ì´í„°ë¡œ í¬ë§·íŒ…
                  return dayjs(originalDate).format('YYYYë…„ Mì›” Dì¼ (ddd)');
                },
                label: function(context) {
                  const candidate = context.dataset.label;
                  const value = context.raw;
                  return `${candidate}: ${value}%`;
                },
                labelPointStyle: function(context) {
                  const candidate = context.dataset.label;
                  return {
                    pointStyle: candidateStyles[candidate].pointStyle,
                    rotation: 0
                  };
                }
              }
            },
            legend: {
              display: false
            }
          },
          interaction: {
            mode: 'nearest',
            intersect: false,
            axis: 'x'
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'ë‚ ì§œ',
                font: {
                  weight: 'bold'
                },
                color: tickColor
              },
              grid: {
                display: false,
                color: gridColor
              },
              ticks: {
                color: tickColor
              }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: 'ë¹„ìœ¨(%)',
                font: {
                  weight: 'bold'
                },
                color: tickColor
              },
              min: 0,
              max: yAxisMax,
              ticks: {
                stepSize: yAxisMax <= 50 ? 5 : 10,
                color: tickColor
              },
              grid: {
                color: gridColor
              }
            }
          }
        };

        // datalabels í”ŒëŸ¬ê·¸ì¸ì´ ë¡œë“œë˜ì—ˆì„ ê²½ìš°ì—ë§Œ ì„¤ì • ì¶”ê°€
        if (ChartDataLabels) {
          chartOptions.plugins.datalabels = {
            align: 'right',
            anchor: 'end',
            formatter: function(value, context) {
              // í›„ë³´ì ì´ë¦„ê³¼ ë¹„ìœ¨ì„ í•¨ê»˜ í‘œì‹œ
              return `${context.dataset.label}: ${value}%`;
            },
            color: function(context) {
              return context.dataset.borderColor;
            },
            font: {
              weight: 'bold',
              size: 12
            },
            offset: 10,
            padding: 6,
            backgroundColor: function(context) {
              const isDarkMode = body.classList.contains('dark-mode');
              return isDarkMode ? 'rgba(40, 40, 40, 0.9)' : 'rgba(255, 255, 255, 0.9)';
            },
            borderColor: function(context) {
              return context.dataset.borderColor;
            },
            borderWidth: 1,
            borderRadius: 4,
            textAlign: 'left',
            display: function(context) {
              // ë§ˆì§€ë§‰ ë°ì´í„° í¬ì¸íŠ¸ì—ë§Œ í‘œì‹œí•˜ê³  ìˆ¨ê²¨ì§„ ê³„ì—´ì€ ì œì™¸
              return context.dataIndex === context.dataset.data.length - 1 && !context.dataset.hidden;
            }
          };
        }

        // ìƒˆ ì°¨íŠ¸ ìƒì„±
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: datasets,
            originalDates: originalDates // ì›ë³¸ ë‚ ì§œ ë°ì´í„° ì¶”ê°€
          },
          options: chartOptions
        });
      }
    }

    function setDateRange(days) {
      const endDate = new Date(allData[0]["date_day"]);
      const startDate = new Date(endDate);
      startDate.setDate(endDate.getDate() - days);

      document.getElementById('startDate').value = formatDate(startDate);
      document.getElementById('endDate').value = formatDate(endDate);

      applyDateFilter();
    }
  </script>
</body>
</html>
