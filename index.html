<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í›„ë³´ ë‹¹ì„  í™•ë¥  ì°¨íŠ¸</title>
  <style>
    /* ê°œì„ ëœ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
    :root {
      --background-color: #f8f9fa;
      --container-bg: white;
      --text-color: #333;
      --border-color: #ddd;
      --header-color: #1a73e8;
      --button-color: #1a73e8;
      --button-hover: #0d47a1;
      --footer-color: #666;
      --spinner-border: #f3f3f3;
      --spinner-top: #1a73e8;
      --box-shadow: rgba(0,0,0,0.1);
    }
    
    .dark-mode {
      --background-color: #121212;
      --container-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --border-color: #444;
      --header-color: #4dabf7;
      --button-color: #4dabf7;
      --button-hover: #74c0fc;
      --footer-color: #adb5bd;
      --spinner-border: #333;
      --spinner-top: #4dabf7;
      --box-shadow: rgba(0,0,0,0.3);
    }
    
    body {
      font-family: 'Noto Sans KR', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--container-bg);
      border-radius: 10px;
      box-shadow: 0 2px 10px var(--box-shadow);
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--header-color);
      transition: color 0.3s;
    }
    
    .chart-container {
      position: relative;
      margin: auto;
      height: 70vh;
      width: 100%;
      padding: 10px;
    }
    
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    
    .loading-spinner {
      border: 5px solid var(--spinner-border);
      border-top: 5px solid var(--spinner-top);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
      transition: border-color 0.3s;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    
    .date-range {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
      justify-content: center;
    }
    
    .date-range label {
      font-weight: bold;
    }
    
    .date-range input {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--container-bg);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    
    button {
      background-color: var(--button-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: var(--button-hover);
    }
    
    .candidate-legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
    }
    
    .legend-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.2s;
      width: 100px;
    }
    
    .legend-item:hover {
      background-color: var(--background-color);
      transform: translateY(-2px);
    }
    
    .legend-image {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-bottom: 8px;
      border: 3px solid transparent;
      transition: border-color 0.2s;
    }
    
    .legend-item.inactive .legend-image {
      opacity: 0.5;
    }
    
    .legend-color {
      display: none; /* ê¸°ì¡´ ìƒ‰ìƒ ë°•ìŠ¤ ìˆ¨ê¹€ */
    }
    
    .legend-text {
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      margin-bottom: 4px;
    }
    
    .legend-percentage {
      font-size: 16px;
      font-weight: bold;
      color: var(--header-color);
    }
    
    .legend-item.inactive .legend-percentage {
      opacity: 0.5;
    }
    
    footer {
      text-align: center;
      margin-top: 30px;
      font-size: 12px;
      color: var(--footer-color);
      transition: color 0.3s;
    }
    
    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .theme-toggle-button {
      background-color: var(--button-color);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background-color 0.3s;
    }
    
    .theme-toggle-button:hover {
      background-color: var(--button-hover);
    }
    
    .theme-icon {
      font-size: 16px;
    }
    
    @media (max-width: 768px) {
      .chart-container {
        height: 60vh;
        padding: 5px;
      }
      
      h1 {
        font-size: 1.2rem;
        margin-bottom: 15px;
      }
      
      .theme-toggle {
        top: 10px;
        right: 10px;
      }
      
      .theme-toggle-button {
        padding: 5px 8px;
        font-size: 12px;
      }
      
      .date-range {
        flex-direction: column;
        align-items: stretch;
        margin-bottom: 10px;
        gap: 5px;
      }
      
      .date-range input, 
      .date-range button {
        margin: 2px 0;
        height: 36px;
        font-size: 13px;
      }
      
      .controls button {
        padding: 6px 10px;
        font-size: 13px;
      }
      
      /* ë ˆì „ë“œ ì•„ì´í…œ í¬ê¸° ì¶•ì†Œ */
      .legend-item {
        padding: 5px;
        width: 70px;
        margin-bottom: 5px;
      }
      
      .legend-item .legend-image,
      .legend-item div[style*="border-radius: 50%"] {
        width: 40px !important;
        height: 40px !important;
        margin-bottom: 4px;
      }
      
      .legend-item .legend-text {
        font-size: 12px;
        margin-bottom: 2px;
      }
      
      .legend-item .legend-percentage {
        font-size: 13px;
      }
      
      /* í›„ë³´ì ë ˆì „ë“œ ê°„ê²© ì¤„ì´ê¸° */
      .candidate-legend > div {
        gap: 8px !important;
      }
      
      .container {
        padding: 10px;
      }
    }
    
    /* ë§¤ìš° ì‘ì€ í™”ë©´ì—ì„œ ì¶”ê°€ ì¶•ì†Œ */
    @media (max-width: 480px) {
      .legend-item {
        width: 60px;
      }
      
      .legend-item .legend-image,
      .legend-item div[style*="border-radius: 50%"] {
        width: 35px !important;
        height: 35px !important;
      }
    }
  </style>
  <!-- Google Fonts - Noto Sans KR -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="theme-toggle">
    <button id="themeToggle" class="theme-toggle-button">
      <span class="theme-icon">ğŸŒ™</span> ë‹¤í¬ëª¨ë“œ
    </button>
  </div>
  <div class="container">
    <h1>2025 ëŒ€ì„  í›„ë³´ë³„ ë‹¹ì„  í™•ë¥  íŠ¸ë Œë“œ</h1>
    
    <div class="date-range">
      <label for="startDate">ì‹œì‘ì¼:</label>
      <input type="date" id="startDate">
      <label for="endDate">ì¢…ë£Œì¼:</label>
      <input type="date" id="endDate">
      <button id="applyDateFilter">ì ìš©</button>
      <button id="resetDateFilter">ì´ˆê¸°í™”</button>
      <button id="lastWeek">ì§ì „ ì¼ì£¼ì¼</button>
      <button id="last30Days">ì§ì „ 30ì¼</button>
      <button id="last3Months">ì§ì „ 3ê°œì›”</button>
    </div>
    
    <div class="candidate-legend" id="candidateLegend">
      <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë™ì  ìƒì„±ë¨ -->
    </div>
    
    <div class="chart-container">
      <div id="loadingIndicator" class="loading">
        <div class="loading-spinner"></div>
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
      <canvas id="electionChart"></canvas>
    </div>
    
    <div class="controls">
      <button id="toggleAllCandidates">ëª¨ë“  í›„ë³´ í‘œì‹œ/ìˆ¨ê¹€</button>
    </div>
    
    <footer>
      ë°ì´í„° ì¶œì²˜: Google Sheets ê³µê°œ CSV | ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">ë¡œë”© ì¤‘...</span>
      <div class="disclaimer" style="margin-top: 15px; font-size: 11px; line-height: 1.4; color: var(--footer-color); max-width: 800px; margin-left: auto; margin-right: auto; text-align: justify;">
        ë³¸ ì›¹ì‚¬ì´íŠ¸ì— ì œê³µë˜ëŠ” ëª¨ë“  ë°ì´í„° ë° ì •ë³´ëŠ” ê³µê°œëœ ìë£Œë¥¼ í† ëŒ€ë¡œ ìˆ˜ì§‘ ë° ê°€ê³µëœ ê²ƒìœ¼ë¡œ, ê·¸ ì •í™•ì„±, ì‹ ë¢°ì„± ë° ì™„ì „ì„±ì— ëŒ€í•´ ì–´ë– í•œ ë³´ì¦ë„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ìš©ìëŠ” ë³¸ ë°ì´í„°ë¥¼ ì „ì ìœ¼ë¡œ ìì‹ ì˜ íŒë‹¨ê³¼ ì±…ì„ í•˜ì— í™œìš©í•˜ë©°, ì´ë¡œ ì¸í•˜ì—¬ ë°œìƒí•˜ëŠ” ëª¨ë“  ë²•ì  ë¬¸ì œ ë° ì†í•´ì— ëŒ€í•´ì„œëŠ” ì›¹ì‚¬ì´íŠ¸ ìš´ì˜ì ë° ê´€ë ¨ ë‹¹ì‚¬ìê°€ ì±…ì„ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤. ë˜í•œ, ë°ì´í„°ì˜ ì €ì‘ê¶Œ, ì‚¬ìš© ê¶Œí•œ ë° ê¸°íƒ€ ë²•ì  ì´ìŠˆì™€ ê´€ë ¨í•˜ì—¬ ì‚¬ì „ í†µì§€ ì—†ì´ ë³€ê²½ë  ìˆ˜ ìˆìŒì„ ëª…ì‹œí•˜ë©°, ë³„ë„ì˜ ëª…ì‹œì  í•©ì˜ê°€ ì—†ëŠ” í•œ ëª¨ë“  ë²•ì  ì±…ì„ì€ ì´ìš©ìì—ê²Œ ìˆìŒì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.
      </div>
    </footer>
  </div>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Datalabels í”ŒëŸ¬ê·¸ì¸ (CDN) - ë²„ì „ ë³€ê²½ ë° ìœ„ì¹˜ ì¡°ì • -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <!-- Papa Parse (CSV íŒŒì‹±ìš©, CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- ë‚ ì§œ í¬ë§·íŒ…ì„ ìœ„í•œ Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/locale/ko.js"></script>

  <script>
    // Chart.js Datalabels í”ŒëŸ¬ê·¸ì¸ ì „ì—­ ë³€ìˆ˜ ì„¤ì • - ì˜¤ë¥˜ ì²˜ë¦¬ ì¶”ê°€
    let ChartDataLabels = null;
    try {
      ChartDataLabels = window['chartjs-plugin-datalabels'];
      // í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
      Chart.register(ChartDataLabels);
    } catch (e) {
      console.error("Datalabels í”ŒëŸ¬ê·¸ì¸ ë¡œë“œ ì˜¤ë¥˜:", e);
    }
    
    // ë‹¤í¬ëª¨ë“œ í† ê¸€ ê¸°ëŠ¥
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    
    // ì‚¬ìš©ì ì‹œìŠ¤í…œ ì„¤ì •ì´ë‚˜ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í…Œë§ˆ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark' || (!savedTheme && prefersDarkScheme.matches)) {
      body.classList.add('dark-mode');
      themeToggle.innerHTML = '<span class="theme-icon">â˜€ï¸</span> ë¼ì´íŠ¸ëª¨ë“œ';
    }
    
    themeToggle.addEventListener('click', () => {
      if (body.classList.contains('dark-mode')) {
        body.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
        themeToggle.innerHTML = '<span class="theme-icon">ğŸŒ™</span> ë‹¤í¬ëª¨ë“œ';
        
        // ì°¨íŠ¸ í…Œë§ˆ ì—…ë°ì´íŠ¸ (ë¼ì´íŠ¸ëª¨ë“œ)
        if (chart) {
          chart.options.scales.x.ticks.color = '#666';
          chart.options.scales.y.ticks.color = '#666';
          chart.options.scales.x.title.color = '#666';
          chart.options.scales.y.title.color = '#666';
          chart.options.plugins.title.color = '#333';
          chart.update();
        }
      } else {
        body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
        themeToggle.innerHTML = '<span class="theme-icon">â˜€ï¸</span> ë¼ì´íŠ¸ëª¨ë“œ';
        
        // ì°¨íŠ¸ í…Œë§ˆ ì—…ë°ì´íŠ¸ (ë‹¤í¬ëª¨ë“œ)
        if (chart) {
          chart.options.scales.x.ticks.color = '#adb5bd';
          chart.options.scales.y.ticks.color = '#adb5bd';
          chart.options.scales.x.title.color = '#e0e0e0';
          chart.options.scales.y.title.color = '#e0e0e0';
          chart.options.plugins.title.color = '#e0e0e0';
          chart.update();
        }
      }
    });
    
    // ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    // Google Sheets ì •ë³´
    const spreadsheetId = '1FBkYF5tZDBCFqyg1U-h9TLikdTDA1NUpxIFAGJ7eDvw'; // ì‹¤ì œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID
    const sheetName = 'csv'; // ì‹¤ì œ ì‹œíŠ¸ ì´ë¦„
    const apiKey = 'AIzaSyBb2nNqLgPKBnOaWdr5dtAoc1U9Wn6v5IU'; // ì‹¤ì œ API í‚¤

    // Google Sheets API URL
    const sheetsApiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}?key=${apiKey}`;
    
    // 2) í›„ë³´ì ì»¬ëŸ¼ ì´ë¦„ (CSV í—¤ë”ì™€ ë™ì¼í•˜ê²Œ)
    //    "date_day" ì™¸ì— ì‹¤ì œ í›„ë³´ ì´ë¦„ ì»¬ëŸ¼ 8ê°œ
    const candidateLabels = [
      "ì´ì¬ëª…", "ê¹€ë™ì—°", "ê¹€ë¬¸ìˆ˜", "í•œë™í›ˆ",
      "í™ì¤€í‘œ", "ì˜¤ì„¸í›ˆ", "ì´ì¤€ì„", "ì´ë‚™ì—°"
    ];
    
    // 3) í›„ë³´ìë³„ ìƒ‰ìƒ ì§€ì •
    const candidateColors = {
      "ì´ì¬ëª…": "#152484",
      "ê¹€ë™ì—°": "#4958B0",
      "ê¹€ë¬¸ìˆ˜": "#E61E2B",
      "í•œë™í›ˆ": "#FF5C6A",
      "í™ì¤€í‘œ": "#B71721",
      "ì˜¤ì„¸í›ˆ": "#FF8A94",
      "ì´ì¤€ì„": "#FF7210",
      "ì´ë‚™ì—°": "#45BABD"
    };
    
    // í›„ë³´ìë³„ ë¼ì¸ ìŠ¤íƒ€ì¼ ì„¤ì •
    const candidateStyles = {
      "ì´ì¬ëª…": { borderDash: [], pointStyle: 'circle' },
      "ê¹€ë™ì—°": { borderDash: [10, 5], pointStyle: 'triangle' },
      "ê¹€ë¬¸ìˆ˜": { borderDash: [], pointStyle: 'rect' },
      "í•œë™í›ˆ": { borderDash: [5, 5], pointStyle: 'triangle' },
      "í™ì¤€í‘œ": { borderDash: [15, 3], pointStyle: 'rect' },
      "ì˜¤ì„¸í›ˆ": { borderDash: [8, 8], pointStyle: 'star' },
      "ì´ì¤€ì„": { borderDash: [2, 2], pointStyle: 'circle' },
      "ì´ë‚™ì—°": { borderDash: [12, 3], pointStyle: 'circle' }
    };
    
    // í›„ë³´ìë³„ ì´ë¯¸ì§€ URL ì—…ë°ì´íŠ¸
    const candidateImages = {
      "ì´ì¬ëª…": "https://i.namu.wiki/i/HRl3tqzehPKPS1ycNmWoijduX-Y8tbda_Tc-TPPwiRt0j67yralDxXTOFbDr1QstdWGIj3BR_wYYbEYOm8JeDthReHTo4wOdf1yWgGRhEoLf-f-u0aC20uhqipZ2kLVpGhruarSsg4jFJAiXrZdTcw.webp",
      "ê¹€ë™ì—°": "https://i.namu.wiki/i/rNjm947tSGuwD8JkqWt7jfR-RhLtLMYqSzA1rNcgbBT63QvJqxSDGuKblhOmkRsDPFQqkSTu59-I72F63T7-GES5DQ1d3WVmhYzO_iomaSL8ckiIX7rqW2tZq1UuttZ58tRtHZoXuwOlFmekyt9uug.webp",
      "ê¹€ë¬¸ìˆ˜": "https://i.namu.wiki/i/IB0A2SrSD5GRod3w6uxKMTkz1yPctPeKla54wtUcc7sdxrEkQjbWIxmkwH0M6gnnfMplo9YZIxRe79jsFhxUhrwLKs-GuLRPFS9POyRBCLLDaofSpK4xsscws4J7b2vQjKIkVvwHjvf4mrhW1Yk2NA.webp",
      "í•œë™í›ˆ": "https://i.namu.wiki/i/y4VZDisGo3iS34VAAsTbjSpsbPrJ6Ox5FFVy-LL2rawisQ8yrHr7ZC5Msk1409f3usVAOToVy03N7H9Z1mozYfXk9qeXid-cRZu0BNN-jq38P2pzKeQHxlPdiTRNZR_87Lixo3NvbX3ZgeNJ3VUhFA.webp",
      "í™ì¤€í‘œ": "https://i.namu.wiki/i/uyc8ltZ5EiLUlTIhXnMcXP3srP0u8aTpvPOy5GbAn-hzXA6ggYHafBWmkuUpQ5-W3PUhcHI1QexFJsjiiM8yQprWQAHTu2XsVevo6on8iQ2XtvqDwcpL7nGZL-_lUkYoeU8YOtKZcfu84qw8wUPykw.webp",
      "ì˜¤ì„¸í›ˆ": "https://i.namu.wiki/i/NZs4RwPqxiSbewfz_aZOJTZmuHvAU1JSl8iugfrgLTLNZmmn8xBgkOjjQYWK3QIUEl3bTZRqUuIbNFeniihOhOMIOskoeqvvDg9uVHeECPqMbm_Q5gdODL79GShJykzH1KOBwsvBuMWxbW4DbnQpMA.webp",
      "ì´ì¤€ì„": "https://i.namu.wiki/i/Kqqk3XNnhU2z-ng5tqtrGmLjU81GOYW_1tcCklq0wZ_xUVUuUmXQgLUVj84UiTZdx0OVnP4RgrhF6zTAuI2Rdpz6MOpq2hamKzJ6jjMWeZew1WDMtw9GjTGtDWGM809m8D_rZxXajFJiU1SrWaErBw.webp",
      "ì´ë‚™ì—°": "https://i.namu.wiki/i/d2H0Nidrt55samE1Q0R8vXYMmeOR6ZlHKGO799ub5uGEWFqZBfKXZu6AdfA33yE1YdUueZcZM_wi4eadUpwBItRF00EO7kEKN8KUcWJO3S3jXQuLFcS6fFB-lRR9Kuro-stqwwsdOG9a7457EyncQQ.webp"
    };
    
    // ì „ì—­ ë³€ìˆ˜
    let chart = null;
    let allData = [];
    let filteredData = [];
    let visibleCandidates = [...candidateLabels];
    let thirtyDaysAgo;
    let lastDate;
    
    // ë‚ ì§œ í˜•ì‹ ë³€í™˜ (YYYY-MM-DD)
    const formatDate = (date) => {
      return date.toISOString().split('T')[0];
    };
    
    // dayjs í•œêµ­ì–´ ë¡œì¼€ì¼ ì„¤ì •
    dayjs.locale('ko');
    
    // Google Sheets APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ë¡œë“œ
    // ì°¸ê³ : Google Sheets APIë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë‹¤ìŒ ë‹¨ê³„ê°€ í•„ìš”í•©ë‹ˆë‹¤:
    // 1. Google Cloud Console(https://console.cloud.google.com/)ì—ì„œ í”„ë¡œì íŠ¸ ìƒì„±
    // 2. Google Sheets API í™œì„±í™”
    // 3. API í‚¤ ìƒì„± (ì œí•œì‚¬í•­: HTTP ë¦¬í¼ëŸ¬ ì œí•œ ì„¤ì • ê¶Œì¥)
    // 4. ìƒì„±ëœ API í‚¤ë¥¼ ìœ„ì˜ apiKey ë³€ìˆ˜ì— ì…ë ¥
    // 5. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDì™€ ì‹œíŠ¸ ì´ë¦„ ì„¤ì •
    //
    // ì‹¤ì œ API í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ Google Sheets APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    loadDataFromGoogleSheetsApi(); // APIë¥¼ í†µí•´ ì‹¤ì œ ë°ì´í„° ë¡œë“œ
    
    // Google Sheets APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    function loadDataFromGoogleSheetsApi() {
      // ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
      loadingIndicator.style.display = 'block';
      loadingIndicator.innerHTML = `
        <div class="loading-spinner"></div>
        <p>Google Sheets APIì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
      `;
      
      fetch(sheetsApiUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data && data.values && data.values.length > 0) {
            // API ì‘ë‹µì—ì„œ ë°ì´í„° ì¶”ì¶œ ë° ê°€ê³µ
            const headers = data.values[0];
            const rows = data.values.slice(1);
            
            const parsedData = rows.map(row => {
              const rowData = {};
              headers.forEach((header, index) => {
                rowData[header] = row[index] || '';
              });
              return rowData;
            });
            
            processData(parsedData);
            
            // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ë‚ ì§œë§Œ ë³€ê²½í•˜ê³  ë©´ì±…ì¡°í•­ì€ ìœ ì§€
            document.getElementById('lastUpdate').textContent = dayjs(parsedData[0].date_day).format('YYYYë…„ MMì›” DDì¼');
          } else {
            throw new Error("API ì‘ë‹µì— ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }
        })
        .catch(err => {
          console.error("Google Sheets API ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", err);
          loadingIndicator.innerHTML = `
            <p>Google Sheets API ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}</p>
            <button id="retryFetch" style="margin-top: 20px;">ë‹¤ì‹œ ì‹œë„</button>
          `;
          
          document.getElementById('retryFetch').addEventListener('click', () => {
            loadDataFromGoogleSheetsApi();
          });
        });
    }
    
    // ë°ì´í„° ì²˜ë¦¬ ê³µí†µ í•¨ìˆ˜
    function processData(data) {
      allData = data;
      
      // ë°ì´í„° ì •ë ¬ (ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ)
      allData.sort((a, b) => {
        return new Date(b["date_day"]) - new Date(a["date_day"]);
      });
      
      // ìµœê·¼ 30ì¼ ë°ì´í„°ë§Œ í•„í„°ë§
      lastDate = new Date(allData[0]["date_day"]);
      thirtyDaysAgo = new Date(lastDate);
      thirtyDaysAgo.setDate(lastDate.getDate() - 30);
      
      filteredData = allData.filter(row => {
        const rowDate = new Date(row["date_day"]);
        return rowDate >= thirtyDaysAgo && rowDate <= lastDate;
      });
      
      // ë‚ ì§œ í•„í„° ì´ˆê¸°í™”
      initializeDateFilters();
      
      // í›„ë³´ì ë ˆì „ë“œ ìƒì„±
      createCandidateLegend();
      
      // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ë‚ ì§œ í‘œì‹œ
      updateLastUpdateDate();
      
      // ì°¨íŠ¸ ë Œë”ë§
      renderChart(filteredData);
      
      // ë¡œë”© ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
      loadingIndicator.style.display = 'none';
    }
    
    // ë‚ ì§œ í•„í„° ì´ˆê¸°í™”
    function initializeDateFilters() {
      if (allData.length === 0) return;
      
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      
      // ë°ì´í„°ì˜ ì²« ë‚ ì§œì™€ ë§ˆì§€ë§‰ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
      const firstDate = new Date(allData[allData.length - 1]["date_day"]);
      
      // ì…ë ¥ í•„ë“œì— ë‚ ì§œ ì„¤ì •
      startDateInput.value = formatDate(thirtyDaysAgo);
      endDateInput.value = formatDate(lastDate);
      
      // ë°ì´í„°ê°€ ìˆëŠ” ë‚ ì§œë“¤ì„ ì¶”ì¶œí•˜ì—¬ ë°°ì—´ë¡œ ì €ì¥
      const availableDates = allData.map(row => row["date_day"]);
      
      // ë‚ ì§œ ì…ë ¥ í•„ë“œì— ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      startDateInput.addEventListener('input', function() {
        validateDateInput(this, availableDates);
      });
      
      endDateInput.addEventListener('input', function() {
        validateDateInput(this, availableDates);
      });
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ë‹¤ì‹œ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
      document.getElementById('applyDateFilter').removeEventListener('click', applyDateFilter);
      document.getElementById('resetDateFilter').removeEventListener('click', resetDateFilter);
      document.getElementById('lastWeek').removeEventListener('click', () => setDateRange(7));
      document.getElementById('last30Days').removeEventListener('click', () => setDateRange(30));
      document.getElementById('last3Months').removeEventListener('click', () => setDateRange(90));
      
      // ë‚ ì§œ í•„í„° ì ìš© ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('applyDateFilter').addEventListener('click', applyDateFilter);
      
      // ë‚ ì§œ í•„í„° ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('resetDateFilter').addEventListener('click', resetDateFilter);
      
      // ë‚ ì§œ ë²”ìœ„ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
      document.getElementById('lastWeek').addEventListener('click', function() { setDateRange(7); });
      document.getElementById('last30Days').addEventListener('click', function() { setDateRange(30); });
      document.getElementById('last3Months').addEventListener('click', function() { setDateRange(90); });
      
      // ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œ ëª©ë¡ì„ ì„¤ì •
      setAvailableDates(startDateInput, availableDates);
      setAvailableDates(endDateInput, availableDates);
    }
    
    // ë‚ ì§œ ì…ë ¥ í•„ë“œì— ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œ ì„¤ì •
    function setAvailableDates(dateInput, availableDates) {
      // ê¸°ì¡´ min, max ì†ì„± ì„¤ì •
      const firstAvailableDate = new Date(availableDates[availableDates.length - 1]);
      const lastAvailableDate = new Date(availableDates[0]);
      
      dateInput.min = formatDate(firstAvailableDate);
      dateInput.max = formatDate(lastAvailableDate);
      
      // ì‚¬ìš©ì ì •ì˜ ë°ì´í„° ì†ì„±ì— ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œ ëª©ë¡ ì €ì¥
      dateInput.dataset.availableDates = JSON.stringify(availableDates);
    }
    
    // ë‚ ì§œ ì…ë ¥ ìœ íš¨ì„± ê²€ì‚¬
    function validateDateInput(input, availableDates) {
      const selectedDate = input.value;
      
      // ì„ íƒëœ ë‚ ì§œê°€ ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œ ëª©ë¡ì— ì—†ìœ¼ë©´ ê°€ì¥ ê°€ê¹Œìš´ ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œë¡œ ë³€ê²½
      if (!availableDates.includes(selectedDate)) {
        // ê°€ì¥ ê°€ê¹Œìš´ ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œ ì°¾ê¸°
        const closestDate = findClosestDate(selectedDate, availableDates);
        input.value = closestDate;
        
        // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
        alert(`ì„ íƒí•˜ì‹  ë‚ ì§œ(${selectedDate})ì—ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê°€ì¥ ê°€ê¹Œìš´ ë‚ ì§œ(${closestDate})ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
    }
    
    // ê°€ì¥ ê°€ê¹Œìš´ ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œ ì°¾ê¸°
    function findClosestDate(targetDate, availableDates) {
      const target = new Date(targetDate);
      
      // ë‚ ì§œ ì°¨ì´ë¥¼ ê³„ì‚°í•˜ì—¬ ê°€ì¥ ê°€ê¹Œìš´ ë‚ ì§œ ì°¾ê¸°
      let closestDate = availableDates[0];
      let minDiff = Math.abs(target - new Date(availableDates[0]));
      
      for (let i = 1; i < availableDates.length; i++) {
        const diff = Math.abs(target - new Date(availableDates[i]));
        if (diff < minDiff) {
          minDiff = diff;
          closestDate = availableDates[i];
        }
      }
      
      return closestDate;
    }
    
    // ë‚ ì§œ í•„í„° ì ìš©
    function applyDateFilter() {
      const startDate = new Date(document.getElementById('startDate').value);
      const endDate = new Date(document.getElementById('endDate').value);
      
      // ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ì´ì „ì´ë©´ ê²½ê³ 
      if (endDate < startDate) {
        alert('ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      // ë‚ ì§œ ë²”ìœ„ì— ë§ëŠ” ë°ì´í„° í•„í„°ë§
      filteredData = allData.filter(row => {
        const rowDate = new Date(row["date_day"]);
        return rowDate >= startDate && rowDate <= endDate;
      });
      
      // ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
      renderChart(filteredData);
    }
    
    // ë‚ ì§œ í•„í„° ì´ˆê¸°í™”
    function resetDateFilter() {
      initializeDateFilters();
      filteredData = [...allData];
      renderChart(filteredData);
    }
    
    // í›„ë³´ì ë ˆì „ë“œ ìƒì„±
    function createCandidateLegend() {
      const legendContainer = document.getElementById('candidateLegend');
      legendContainer.innerHTML = '';
      
      // í›„ë³´ì ë²”ë¡€ë¥¼ ë‹´ì„ div ìƒì„±
      const candidatesDiv = document.createElement('div');
      candidatesDiv.style.display = 'flex';
      candidatesDiv.style.flexWrap = 'wrap';
      candidatesDiv.style.gap = '15px'; // ê¸°ë³¸ ê°„ê²©ì€ 15px
      candidatesDiv.style.justifyContent = 'center';
      
      // ëª¨ë°”ì¼ í™”ë©´ì—ì„œëŠ” ê°„ê²© ì¶•ì†Œ
      if (window.innerWidth <= 768) {
        candidatesDiv.style.gap = '8px';
      }
      
      // ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const latestData = allData[0];
      
      // í›„ë³´ìë¥¼ ìµœì‹  í¼ì„¼íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
      const sortedCandidates = [...candidateLabels].sort((a, b) => {
        const valueA = parseFloat((latestData[a] || "0%").replace("%", "")) || 0;
        const valueB = parseFloat((latestData[b] || "0%").replace("%", "")) || 0;
        return valueB - valueA; // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
      });
      
      // ì´ë¯¸ì§€ í¬ê¸° - ëª¨ë°”ì¼ê³¼ ë°ìŠ¤í¬í†± ëŒ€ì‘
      const imageSize = window.innerWidth <= 768 ? '40px' : '60px';
      
      sortedCandidates.forEach(candidate => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.dataset.candidate = candidate;
        
        // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ìˆ˜ì • - ëª¨ë°”ì¼ ëŒ€ì‘
        const imageContainer = document.createElement('div');
        imageContainer.style.width = imageSize;
        imageContainer.style.height = imageSize;
        imageContainer.style.borderRadius = '50%';
        imageContainer.style.backgroundColor = candidateColors[candidate];
        imageContainer.style.border = `3px solid ${candidateColors[candidate]}`;
        imageContainer.style.display = 'flex';
        imageContainer.style.alignItems = 'center';
        imageContainer.style.justifyContent = 'center';
        imageContainer.style.marginBottom = '8px';
        imageContainer.style.overflow = 'hidden';
        
        // ì´ë¯¸ì§€ ìš”ì†Œ ìˆ˜ì • - íˆ´íŒê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼
        const image = new Image();
        image.className = 'legend-image';
        image.src = candidateImages[candidate];
        image.alt = candidate;
        image.style.width = '100%'; // 100%ë¡œ ë³€ê²½ (íˆ´íŒê³¼ ë™ì¼)
        image.style.height = '100%'; // 100%ë¡œ ë³€ê²½ (íˆ´íŒê³¼ ë™ì¼)
        image.style.objectFit = 'cover';
        image.style.borderRadius = '0'; // í…Œë‘ë¦¬ ì—†ì•° (ì»¨í…Œì´ë„ˆê°€ ì´ë¯¸ ì›í˜•)
        
        // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ì‹œ ëŒ€ì²´ í…ìŠ¤íŠ¸ í‘œì‹œ
        image.onerror = () => {
          imageContainer.innerHTML = `
            <span style="color: white; font-weight: bold; font-size: 20px;">
              ${candidate.charAt(0)}
            </span>
          `;
        };
        
        // ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µì‹œ
        image.onload = () => {
          imageContainer.innerHTML = '';
          imageContainer.appendChild(image);
        };
        
        // í›„ë³´ì ì´ë¦„
        const text = document.createElement('span');
        text.className = 'legend-text';
        text.textContent = candidate;
        
        // ìµœì‹  í¼ì„¼íŠ¸ ê°’
        const percentage = document.createElement('span');
        percentage.className = 'legend-percentage';
        const latestValue = latestData[candidate] || "0%";
        percentage.textContent = latestValue;
        
        legendItem.appendChild(imageContainer);
        legendItem.appendChild(text);
        legendItem.appendChild(percentage);
        
        // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        legendItem.addEventListener('click', () => {
          toggleCandidate(candidate, legendItem);
          imageContainer.style.borderColor = visibleCandidates.includes(candidate) ? 
            candidateColors[candidate] : 'transparent';
        });
        
        candidatesDiv.appendChild(legendItem);
      });
      
      // ë°”ë¡œ candidatesDivë¥¼ legendContainerì— ì¶”ê°€
      legendContainer.appendChild(candidatesDiv);
      
      // ëª¨ë“  í›„ë³´ í‘œì‹œ/ìˆ¨ê¹€ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('toggleAllCandidates').addEventListener('click', toggleAllCandidates);
    }
    
    // í›„ë³´ì í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
    function toggleCandidate(candidate, legendItem) {
      const index = visibleCandidates.indexOf(candidate);
      
      if (index !== -1) {
        // í›„ë³´ì ìˆ¨ê¸°ê¸°
        visibleCandidates.splice(index, 1);
        legendItem.classList.add('inactive');
      } else {
        // í›„ë³´ì í‘œì‹œ
        visibleCandidates.push(candidate);
        legendItem.classList.remove('inactive');
      }
      
      // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
      updateChartVisibility();
    }
    
    // ëª¨ë“  í›„ë³´ì í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
    function toggleAllCandidates() {
      const legendTexts = document.querySelectorAll('.legend-text');
      
      if (visibleCandidates.length > 0) {
        // ëª¨ë“  í›„ë³´ì ìˆ¨ê¸°ê¸°
        visibleCandidates = [];
        legendTexts.forEach(text => text.classList.add('inactive'));
      } else {
        // ëª¨ë“  í›„ë³´ì í‘œì‹œ
        visibleCandidates = [...candidateLabels];
        legendTexts.forEach(text => text.classList.remove('inactive'));
      }
      
      // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
      updateChartVisibility();
    }
    
    // ì°¨íŠ¸ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
    function updateChartVisibility() {
      if (!chart) return;
      
      chart.data.datasets.forEach(dataset => {
        const isVisible = visibleCandidates.includes(dataset.label);
        dataset.hidden = !isVisible;
      });
      
      chart.update();
    }
    
    // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ë‚ ì§œ í‘œì‹œ
    function updateLastUpdateDate() {
      if (allData.length === 0) return;
      
      const lastDate = new Date(allData[0]["date_day"]);
      const formattedDate = dayjs(lastDate).format('YYYYë…„ MMì›” DDì¼');
      
      // lastUpdate ìš”ì†Œë§Œ ì—…ë°ì´íŠ¸í•˜ê³  ë©´ì±…ì¡°í•­ì€ ìœ ì§€
      document.getElementById('lastUpdate').textContent = formattedDate;
    }

    // ì´ë¯¸ì§€ ìºì‹œë¥¼ ì „ì—­ìœ¼ë¡œ ì •ì˜ (ì°¨íŠ¸ì™€ íˆ´íŒì´ ê³µìœ )
    const candidateImagesCache = {};

    // Chart.js ê¸°ë³¸ íˆ´íŒì„ ì»¤ìŠ¤í…€ HTML íˆ´íŒìœ¼ë¡œ ëŒ€ì²´
    const externalTooltipHandler = (context) => {
      // íˆ´íŒ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
      const {chart, tooltip} = context;
      const tooltipEl = getOrCreateTooltip(chart);

      // íˆ´íŒì´ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ ìˆ¨ê¸°ê¸°
      if (tooltip.opacity === 0) {
        tooltipEl.style.opacity = 0;
        return;
      }

      // íˆ´íŒ ë°ì´í„° ì„¤ì •
      if (tooltip.body) {
        // í—¤ë” í…ìŠ¤íŠ¸ ì„¤ì •
        const titleLines = tooltip.title || [];
        
        // íˆ´íŒ ë‚´ìš© ì´ˆê¸°í™”
        const tooltipRoot = tooltipEl.querySelector('.tooltip-content');
        tooltipRoot.innerHTML = '';
        
        // ì œëª© ì¶”ê°€
        const titleElement = document.createElement('div');
        titleElement.style.borderBottom = '1px solid #ddd';
        titleElement.style.marginBottom = '6px';
        titleElement.style.paddingBottom = '4px';
        titleElement.style.fontWeight = 'bold';
        titleElement.style.fontSize = '14px';
        
        // ë‚ ì§œ ì œëª© í…ìŠ¤íŠ¸ ì„¤ì • (ê¸°ì¡´ í˜•ì‹ ìœ ì§€)
        if (titleLines.length) {
          const dateStr = titleLines[0];
          titleElement.textContent = dateStr;
        }
        
        tooltipRoot.appendChild(titleElement);
        
        // íˆ´íŒ ë‚´ìš© ì˜ì—­
        const bodyContainer = document.createElement('div');
        bodyContainer.style.display = 'flex';
        bodyContainer.style.flexDirection = 'column';
        bodyContainer.style.gap = '6px';
        
        // ì •ë ¬í•  ë°ì´í„°í¬ì¸íŠ¸ ë°°ì—´ ë³µì‚¬ (ìˆ¨ê²¨ì§„ í›„ë³´ì ì œì™¸)
        const sortedDataPoints = tooltip.dataPoints
          .filter(dataPoint => !dataPoint.dataset.hidden)
          .slice();
        
        // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ê°’ì´ í° ìˆœì„œëŒ€ë¡œ)
        sortedDataPoints.sort((a, b) => b.raw - a.raw);
        
        // ê° í›„ë³´ì í•­ëª© ì¶”ê°€ (ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ëœ ë°ì´í„° ì‚¬ìš©)
        sortedDataPoints.forEach((dataPoint) => {
          const candidate = dataPoint.dataset.label;
          const value = dataPoint.raw; // raw ê°’ì€ ìˆ«ì í˜•íƒœ
          const color = dataPoint.dataset.borderColor;
          
          // í›„ë³´ì í•­ëª© ì»¨í…Œì´ë„ˆ
          const candidateItem = document.createElement('div');
          candidateItem.style.display = 'flex';
          candidateItem.style.alignItems = 'center';
          candidateItem.style.gap = '8px';
          
          // ì´ë¯¸ì§€ ë˜ëŠ” ìƒ‰ìƒ ì› í‘œì‹œ
          const iconContainer = document.createElement('div');
          iconContainer.style.width = '24px';
          iconContainer.style.height = '24px';
          iconContainer.style.position = 'relative';
          
          // ì´ë¯¸ì§€ ìºì‹œì—ì„œ ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
          const cachedImg = candidateImagesCache[candidate];
          
          if (cachedImg && cachedImg !== 'error') {
            // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ (ì› ëª¨ì–‘)
            iconContainer.style.borderRadius = '50%';
            iconContainer.style.overflow = 'hidden';
            iconContainer.style.border = `2px solid ${color}`;
            
            // ì´ë¯¸ì§€ ìš”ì†Œ
            const imgElement = document.createElement('img');
            imgElement.src = candidateImages[candidate];
            imgElement.style.width = '100%';
            imgElement.style.height = '100%';
            imgElement.style.objectFit = 'cover';
            
            iconContainer.appendChild(imgElement);
          } else {
            // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ì›í˜• ìƒ‰ìƒ í‘œì‹œ
            iconContainer.style.backgroundColor = color;
            iconContainer.style.borderRadius = '50%';
          }
          
          // í›„ë³´ì ì´ë¦„ ë° ê°’
          const textContainer = document.createElement('div');
          textContainer.style.display = 'flex';
          textContainer.style.justifyContent = 'space-between';
          textContainer.style.flex = '1';
          
          const nameElement = document.createElement('span');
          nameElement.textContent = candidate;
          nameElement.style.fontWeight = '500';
          
          const valueElement = document.createElement('span');
          valueElement.textContent = value + '%'; // '%' ê¸°í˜¸ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€
          valueElement.style.fontWeight = 'bold';
          
          textContainer.appendChild(nameElement);
          textContainer.appendChild(valueElement);
          
          candidateItem.appendChild(iconContainer);
          candidateItem.appendChild(textContainer);
          
          bodyContainer.appendChild(candidateItem);
        });
        
        tooltipRoot.appendChild(bodyContainer);
      }

      // ëª¨ë°”ì¼ í™”ë©´ì¸ì§€ í™•ì¸
      const isMobile = window.innerWidth <= 768;
      
      // íˆ´íŒ ìœ„ì¹˜ ë° í‘œì‹œ ì„¤ì • ìˆ˜ì •
      const {offsetLeft: positionX, offsetTop: positionY} = chart.canvas;
      
      tooltipEl.style.opacity = 1;
      tooltipEl.style.left = positionX + tooltip.caretX + 'px';
      
      if (isMobile) {
        // ëª¨ë°”ì¼ì—ì„œëŠ” ì»¤ì„œ ì•„ë˜ì— í‘œì‹œ
        tooltipEl.style.top = positionY + tooltip.caretY + 20 + 'px';
        tooltipEl.style.transform = 'translate(-50%, 0)';
        
        // ëª¨ë°”ì¼ì—ì„œ íˆ´íŒ í¬ê¸° ì¡°ì •
        tooltipEl.style.maxWidth = '80vw';
        tooltipEl.style.minWidth = '160px';
        tooltipEl.style.fontSize = '12px';
      } else {
        // ë°ìŠ¤í¬í†±ì—ì„œëŠ” ê¸°ì¡´ ë°©ì‹ëŒ€ë¡œ ìœ„ì— í‘œì‹œ
        tooltipEl.style.top = positionY + tooltip.caretY + 10 + 'px';
        tooltipEl.style.transform = 'translate(-50%, -110%)';
      }
    };

    // íˆ´íŒ ìš”ì†Œ ìƒì„± ë˜ëŠ” ê°€ì ¸ì˜¤ê¸° - ëª¨ë°”ì¼ ëŒ€ì‘
    const getOrCreateTooltip = (chart) => {
      let tooltipEl = document.getElementById('chartjs-tooltip');
      
      if (!tooltipEl) {
        tooltipEl = document.createElement('div');
        tooltipEl.id = 'chartjs-tooltip';
        tooltipEl.style.background = 'rgba(255, 255, 255, 0.95)';
        tooltipEl.style.borderRadius = '5px';
        tooltipEl.style.color = '#333';
        tooltipEl.style.opacity = 0;
        tooltipEl.style.pointerEvents = 'none';
        tooltipEl.style.position = 'absolute';
        tooltipEl.style.transition = 'all .1s ease';
        tooltipEl.style.minWidth = '200px';
        tooltipEl.style.padding = '10px';
        tooltipEl.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
        tooltipEl.style.zIndex = '999';
        
        // ëª¨ë°”ì¼ì—ì„œ íˆ´íŒì´ í™”ë©´ ë°–ìœ¼ë¡œ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì„¤ì •
        tooltipEl.style.maxWidth = window.innerWidth <= 768 ? '80vw' : 'none';
        
        const tooltipContent = document.createElement('div');
        tooltipContent.className = 'tooltip-content';
        tooltipEl.appendChild(tooltipContent);
        
        document.body.appendChild(tooltipEl);
      }
      
      return tooltipEl;
    };

    // ì°¨íŠ¸ë¥¼ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    function renderChart(rows) {
      // (1) Xì¶• ë¼ë²¨ë¡œ ì‚¬ìš©í•  ë°°ì—´ (date_day)
      const labels = [];
      // ì›ë³¸ ë‚ ì§œ ë°ì´í„° ì €ì¥ ë°°ì—´ ì¶”ê°€
      const originalDates = [];

      // (2) í›„ë³´ìë³„ ë°ì´í„° ì €ì¥ìš© ê°ì²´
      //     ì˜ˆ: { "ì´ì¬ëª…": [], "ê¹€ë™ì—°": [], ... }
      const candidateDataMap = {};
      candidateLabels.forEach(candidate => {
        candidateDataMap[candidate] = [];
      });

      // ë°ì´í„°ë¥¼ ì—­ìˆœìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸° ì „ì— ì›ë³¸ ë°°ì—´ ë³µì‚¬
      const sortedRows = [...rows].reverse();

      // (3) CSV ê° í–‰ì„ ìˆœíšŒí•˜ë©°, date_dayì™€ í›„ë³´ì í¼ì„¼íŠ¸ë¥¼ ì¶”ì¶œ
      // ë°ì´í„°ë¥¼ ì—­ìˆœìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ì˜¤ë˜ëœ ë‚ ì§œë¶€í„° ìµœì‹  ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬
      sortedRows.forEach(row => {
        // A. Xì¶• ë¼ë²¨: row["date_day"] (ì˜ˆ: "2025-03-10")
        const dateDay = row["date_day"];
        // ì›ë³¸ ë‚ ì§œ ì €ì¥
        originalDates.push(dateDay);
        // ë‚ ì§œ í¬ë§·íŒ… (M/D(ddd))
        const formattedDate = dayjs(dateDay).format('M/D(ddd)');
        labels.push(formattedDate);

        // B. í›„ë³´ìë³„ í¼ì„¼íŠ¸ ê°’ì„ ìˆ«ìë¡œ ë³€í™˜
        candidateLabels.forEach(candidate => {
          // ì˜ˆ: row["ì´ì¬ëª…"]ê°€ "44%" í˜•íƒœë¼ë©´, "%" ì œê±° í›„ parseFloat
          const rawValue = row[candidate] || "0%";
          const numericValue = parseFloat(rawValue.replace("%", "")) || 0;
          candidateDataMap[candidate].push(numericValue);
        });
      });

      // (4) Chart.jsì— ì‚¬ìš©í•  datasets ë°°ì—´ ìƒì„±
      const datasets = candidateLabels.map(candidate => {
        const dataset = {
          label: candidate,
          data: candidateDataMap[candidate],
          fill: false,
          borderWidth: 4,
          borderColor: candidateColors[candidate],
          backgroundColor: candidateColors[candidate],
          tension: 0.2,
          pointRadius: new Array(candidateDataMap[candidate].length).fill(4),
          pointHoverRadius: 10,
          borderDash: candidateStyles[candidate].borderDash,
          pointStyle: candidateStyles[candidate].pointStyle,
          hidden: !visibleCandidates.includes(candidate)
        };

        // ìµœì‹  ë°ì´í„° í¬ì¸íŠ¸ ê°•ì¡°
        if (dataset.data.length > 0) {
          dataset.pointRadius[dataset.data.length - 1] = 6;
          dataset.pointBorderWidth = new Array(dataset.data.length).fill(1.5);
          dataset.pointBorderWidth[dataset.data.length - 1] = 3;
          dataset.pointBackgroundColor = new Array(dataset.data.length).fill(dataset.backgroundColor);
          dataset.pointBackgroundColor[dataset.data.length - 1] = body.classList.contains('dark-mode') ? '#ffffff' : '#ffffff';
        }

        return dataset;
      });

      // (5) ì°¨íŠ¸ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
      const ctx = document.getElementById('electionChart').getContext('2d');
      
      // ìµœëŒ€ê°’ ê³„ì‚°
      let maxValue = 0;
      candidateLabels.forEach(candidate => {
        const candidateMax = Math.max(...candidateDataMap[candidate]);
        maxValue = Math.max(maxValue, candidateMax);
      });

      // Yì¶• ìµœëŒ€ê°’ ì„¤ì • (ê¸°ë³¸ 50%, ë°ì´í„°ê°€ 50% ì´ˆê³¼ì‹œ ì˜¬ë¦¼í•˜ì—¬ ì„¤ì •)
      const yAxisMax = maxValue > 50 ? Math.ceil(maxValue / 10) * 10 : 50;

      if (chart) {
        // ê¸°ì¡´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        chart.data.labels = labels;
        chart.data.datasets = datasets;
        chart.data.originalDates = originalDates; // ì›ë³¸ ë‚ ì§œ ë°ì´í„° ì—…ë°ì´íŠ¸
        chart.options.scales.y.max = yAxisMax;
        chart.update();
      } else {
        // ë‹¤í¬ëª¨ë“œ ì—¬ë¶€ì— ë”°ë¥¸ ì°¨íŠ¸ ìƒ‰ìƒ ì„¤ì •
        const isDarkMode = body.classList.contains('dark-mode');
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = isDarkMode ? '#e0e0e0' : '#333';
        const tickColor = isDarkMode ? '#adb5bd' : '#666';
        
        // ì°¨íŠ¸ ì˜µì…˜ ì„¤ì •
        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'í›„ë³´ìë³„ ê²€ìƒ‰ ë¹„ìœ¨(%)',
              font: {
                size: 16,
                weight: 'bold'
              },
              padding: {
                top: 10,
                bottom: 20
              },
              color: textColor
            },
            tooltip: {
              enabled: false,  // ê¸°ë³¸ íˆ´íŒ ë¹„í™œì„±í™”
              external: externalTooltipHandler,  // ì»¤ìŠ¤í…€ íˆ´íŒ ì‚¬ìš©
              mode: 'index',
              intersect: false
            },
            // datalabels í”ŒëŸ¬ê·¸ì¸ ë¹„í™œì„±í™” (ì¤‘ë³µ íˆ´íŒ ë°©ì§€)
            datalabels: {
              display: false
            }
          },
          scales: {
            x: {
              ticks: {
                color: tickColor,
                maxRotation: 45,
                minRotation: 45,
                font: {
                  size: 11
                },
                autoSkip: true,
                autoSkipPadding: 10
              },
              grid: {
                display: false
              }
            },
            y: {
              ticks: {
                color: tickColor,
                font: {
                  size: 11
                },
                callback: function(value) {
                  return value + '%';
                }
              },
              grid: {
                display: false
              }
            }
          }
        };

        // Chart ê°ì²´ ìƒì„± ì‹œ í”ŒëŸ¬ê·¸ì¸ í¬í•¨
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: datasets,
            originalDates: originalDates
          },
          options: chartOptions,
          plugins: [candidateLabelPlugin]
        });
      }
    }

    // 2. candidateLabelPlugin ì¶”ê°€
    // ì°¨íŠ¸ ìœ„ì— í›„ë³´ì ì´ë¦„ì„ í‘œì‹œí•˜ëŠ” í”ŒëŸ¬ê·¸ì¸ ì •ì˜
    const candidateLabelPlugin = {
      id: 'candidateLabels',
      beforeInit: (chart) => {
        // ì°¨íŠ¸ê°€ ì²˜ìŒ ì´ˆê¸°í™”ë  ë•Œë§Œ ì´ë¯¸ì§€ ë¡œë“œ (ì„±ëŠ¥ ê°œì„ )
        candidateLabels.forEach(candidate => {
          if (!candidateImagesCache[candidate]) {
            const img = new Image();
            img.src = candidateImages[candidate];
            img.onload = () => {
              candidateImagesCache[candidate] = img;
            };
            img.onerror = () => {
              console.log(`í›„ë³´ì ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ${candidate}`);
              candidateImagesCache[candidate] = 'error'; 
            };
          }
        });
      },
    };

    function setDateRange(days) {
      const endDate = new Date(allData[0]["date_day"]);
      const startDate = new Date(endDate);
      startDate.setDate(endDate.getDate() - days);

      document.getElementById('startDate').value = formatDate(startDate);
      document.getElementById('endDate').value = formatDate(endDate);

      applyDateFilter();
    }
  </script>
</body>
</html>
